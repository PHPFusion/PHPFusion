/*!
 * Nestable jQuery Plugin - Copyright (c) 2012 David Bushell - http://dbushell.com/
 * Dual-licensed under the BSD or MIT licenses
 */
;(function(f,c,a,h){var e="ontouchstart" in a;var d=(function(){var j=a.createElement("div"),k=a.documentElement;if(!("pointerEvents" in j.style)){return false}j.style.pointerEvents="auto";j.style.pointerEvents="x";k.appendChild(j);var i=c.getComputedStyle&&c.getComputedStyle(j,"").pointerEvents==="auto";k.removeChild(j);return !!i})();var g={listNodeName:"ol",itemNodeName:"li",rootClass:"dd",listClass:"dd-list",itemClass:"dd-item",dragClass:"dd-dragel",handleClass:"dd-handle",collapsedClass:"dd-collapsed",placeClass:"dd-placeholder",noDragClass:"dd-nodrag",emptyClass:"dd-empty",expandBtnHTML:'<button data-action="expand" type="button">Expand</button>',collapseBtnHTML:'<button data-action="collapse" type="button">Collapse</button>',group:0,maxDepth:5,threshold:20};function b(j,i){this.w=f(a);this.el=f(j);this.options=f.extend({},g,i);this.init()}b.prototype={init:function(){var l=this;l.reset();l.el.data("nestable-group",this.options.group);l.placeEl=f('<div class="'+l.options.placeClass+'"/>');f.each(this.el.find(l.options.itemNodeName),function(m,n){l.setParent(f(n))});l.el.on("click","button",function(p){if(l.dragEl){return}var o=f(p.currentTarget),n=o.data("action"),m=o.parent(l.options.itemNodeName);if(n==="collapse"){l.collapseItem(m)}if(n==="expand"){l.expandItem(m)}});var i=function(n){var m=f(n.target);if(!m.hasClass(l.options.handleClass)){if(m.closest("."+l.options.noDragClass).length){return}m=m.closest("."+l.options.handleClass)}if(!m.length||l.dragEl){return}l.isTouch=/^touch/.test(n.type);if(l.isTouch&&n.touches.length!==1){return}n.preventDefault();l.dragStart(n.touches?n.touches[0]:n)};var k=function(m){if(l.dragEl){m.preventDefault();l.dragMove(m.touches?m.touches[0]:m)}};var j=function(m){if(l.dragEl){m.preventDefault();l.dragStop(m.touches?m.touches[0]:m)}};if(e){l.el[0].addEventListener("touchstart",i,false);c.addEventListener("touchmove",k,false);c.addEventListener("touchend",j,false);c.addEventListener("touchcancel",j,false)}l.el.on("mousedown",i);l.w.on("mousemove",k);l.w.on("mouseup",j)},serialize:function(){var j,k=0,i=this;step=function(o,m){var n=[],l=o.children(i.options.itemNodeName);l.each(function(){var p=f(this),r=f.extend({},p.data()),q=p.children(i.options.listNodeName);if(q.length){r.children=step(q,m+1)}n.push(r)});return n};j=step(i.el.find(i.options.listNodeName).first(),k);return j},serialise:function(){return this.serialize()},reset:function(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0};this.isTouch=false;this.moving=false;this.dragEl=null;this.dragRootEl=null;this.dragDepth=0;this.hasNewRoot=false;this.pointEl=null},expandItem:function(i){i.removeClass(this.options.collapsedClass);i.children('[data-action="expand"]').hide();i.children('[data-action="collapse"]').show();i.children(this.options.listNodeName).show()},collapseItem:function(j){var i=j.children(this.options.listNodeName);if(i.length){j.addClass(this.options.collapsedClass);j.children('[data-action="collapse"]').hide();j.children('[data-action="expand"]').show();j.children(this.options.listNodeName).hide()}},expandAll:function(){var i=this;i.el.find(i.options.itemNodeName).each(function(){i.expandItem(f(this))})},collapseAll:function(){var i=this;i.el.find(i.options.itemNodeName).each(function(){i.collapseItem(f(this))})},setParent:function(i){if(i.children(this.options.listNodeName).length){i.prepend(f(this.options.expandBtnHTML));i.prepend(f(this.options.collapseBtnHTML))}i.children('[data-action="expand"]').hide()},unsetParent:function(i){i.removeClass(this.options.collapsedClass);i.children("[data-action]").remove();i.children(this.options.listNodeName).remove()},dragStart:function(o){var k=this.mouse,n=f(o.target),m=n.closest(this.options.itemNodeName);this.placeEl.css("height",m.height());k.offsetX=o.offsetX!==h?o.offsetX:o.pageX-n.offset().left;k.offsetY=o.offsetY!==h?o.offsetY:o.pageY-n.offset().top;k.startX=k.lastX=o.pageX;k.startY=k.lastY=o.pageY;this.dragRootEl=this.el;this.dragEl=f(a.createElement(this.options.listNodeName)).addClass(this.options.listClass+" "+this.options.dragClass);this.dragEl.css("width",m.width());m.after(this.placeEl);m[0].parentNode.removeChild(m[0]);m.appendTo(this.dragEl);f(a.body).append(this.dragEl);this.dragEl.css({left:o.pageX-k.offsetX,top:o.pageY-k.offsetY});var l,p,j=this.dragEl.find(this.options.itemNodeName);for(l=0;l<j.length;l++){p=f(j[l]).parents(this.options.listNodeName).length;if(p>this.dragDepth){this.dragDepth=p}}},dragStop:function(j){var i=this.dragEl.children(this.options.itemNodeName).first();i[0].parentNode.removeChild(i[0]);this.placeEl.replaceWith(i);this.dragEl.remove();this.el.trigger("change");if(this.hasNewRoot){this.dragRootEl.trigger("change")}this.reset()},dragMove:function(p){var q,u,k,n,m,j=this.options,r=this.mouse;this.dragEl.css({left:p.pageX-r.offsetX,top:p.pageY-r.offsetY});r.lastX=r.nowX;r.lastY=r.nowY;r.nowX=p.pageX;r.nowY=p.pageY;r.distX=r.nowX-r.lastX;r.distY=r.nowY-r.lastY;r.lastDirX=r.dirX;r.lastDirY=r.dirY;r.dirX=r.distX===0?0:r.distX>0?1:-1;r.dirY=r.distY===0?0:r.distY>0?1:-1;var i=Math.abs(r.distX)>Math.abs(r.distY)?1:0;if(!r.moving){r.dirAx=i;r.moving=true;return}if(r.dirAx!==i){r.distAxX=0;r.distAxY=0}else{r.distAxX+=Math.abs(r.distX);if(r.dirX!==0&&r.dirX!==r.lastDirX){r.distAxX=0}r.distAxY+=Math.abs(r.distY);if(r.dirY!==0&&r.dirY!==r.lastDirY){r.distAxY=0}}r.dirAx=i;if(r.dirAx&&r.distAxX>=j.threshold){r.distAxX=0;k=this.placeEl.prev(j.itemNodeName);if(r.distX>0&&k.length&&!k.hasClass(j.collapsedClass)){q=k.find(j.listNodeName).last();m=this.placeEl.parents(j.listNodeName).length;if(m+this.dragDepth<=j.maxDepth){if(!q.length){q=f("<"+j.listNodeName+"/>").addClass(j.listClass);q.append(this.placeEl);k.append(q);this.setParent(k)}else{q=k.children(j.listNodeName).last();q.append(this.placeEl)}}}if(r.distX<0){n=this.placeEl.next(j.itemNodeName);if(!n.length){u=this.placeEl.parent();this.placeEl.closest(j.itemNodeName).after(this.placeEl);if(!u.children().length){this.unsetParent(u.parent())}}}}var l=false;if(!d){this.dragEl[0].style.visibility="hidden"}this.pointEl=f(a.elementFromPoint(p.pageX-a.body.scrollLeft,p.pageY-(c.pageYOffset||a.documentElement.scrollTop)));if(!d){this.dragEl[0].style.visibility="visible"}if(this.pointEl.hasClass(j.handleClass)){this.pointEl=this.pointEl.parent(j.itemNodeName)}if(this.pointEl.hasClass(j.emptyClass)){l=true}else{if(!this.pointEl.length||!this.pointEl.hasClass(j.itemClass)){return}}var o=this.pointEl.closest("."+j.rootClass),t=this.dragRootEl.data("nestable-id")!==o.data("nestable-id");if(!r.dirAx||t||l){if(t&&j.group!==o.data("nestable-group")){return}m=this.dragDepth-1+this.pointEl.parents(j.listNodeName).length;if(m>j.maxDepth){return}var s=p.pageY<(this.pointEl.offset().top+this.pointEl.height()/2);u=this.placeEl.parent();if(l){q=f(a.createElement(j.listNodeName)).addClass(j.listClass);q.append(this.placeEl);this.pointEl.replaceWith(q)}else{if(s){this.pointEl.before(this.placeEl)}else{this.pointEl.after(this.placeEl)}}if(!u.children().length){this.unsetParent(u.parent())}if(!this.dragRootEl.find(j.itemNodeName).length){this.dragRootEl.append('<div class="'+j.emptyClass+'"/>')}if(t){this.dragRootEl=o;this.hasNewRoot=this.el[0]!==this.dragRootEl[0]}}}};f.fn.nestable=function(k){var i=this,j=this;i.each(function(){var l=f(this).data("nestable");if(!l){f(this).data("nestable",new b(this,k));f(this).data("nestable-id",new Date().getTime())}else{if(typeof k==="string"&&typeof l[k]==="function"){j=l[k]()}}});return j||i}})(window.jQuery||window.Zepto,window,document);