(function(a){a.fn.justifiedGallery=function(j){var b=a.extend({sizeRangeSuffixes:{lt100:"_t",lt240:"_m",lt320:"_n",lt500:"",lt640:"_z",lt1024:"_b"},rowHeight:120,margins:1,justifyLastRow:true,fixedHeight:false,captions:true,rel:null,target:null,extension:/\.[^.]+$/,refreshTime:500,onComplete:null},j);function h(k,l){return'<div class="jg-error '+l+'"style="">'+k+"</div>"}return this.each(function(n,l){a(l).addClass("justifiedGallery");var m=0;var k=new Array(a(l).find("img").length);if(k.length==0){return}a(l).append('<div class="jg-loading"><div class="jg-loading-img"></div></div>');a(l).find("a").each(function(q,r){var p=a(r).find("img");k[q]=new Array(5);k[q]["src"]=(typeof a(p).data("safe-src")!="undefined")?a(p).data("safe-src"):a(p).attr("src");k[q]["alt"]=a(p).attr("alt");k[q]["href"]=a(r).attr("href");k[q]["title"]=a(r).attr("title");k[q]["rel"]=(b.rel!=null)?b.rel:a(r).attr("rel");k[q]["target"]=(b.target!=null)?b.target:a(r).attr("target");k[q]["extension"]=k[q]["src"].match(b.extension)[0];a(r).remove();var o=new Image();a(o).load(function(){if(k[q]["height"]!=b.rowHeight){k[q]["width"]=Math.ceil(this.width/(this.height/b.rowHeight))}else{k[q]["width"]=this.width}k[q]["height"]=b.rowHeight;var s=new RegExp("("+b.sizeRangeSuffixes.lt100+"|"+b.sizeRangeSuffixes.lt240+"|"+b.sizeRangeSuffixes.lt320+"|"+b.sizeRangeSuffixes.lt500+"|"+b.sizeRangeSuffixes.lt640+"|"+b.sizeRangeSuffixes.lt1024+")$");k[q]["src"]=k[q]["src"].replace(b.extension,"").replace(s,"");if(++m==k.length){e(l,k,b)}});a(o).error(function(){a(l).prepend(h("The image can't be loaded: \""+k[q]["src"]+'"',"jg-usedPrefixImageNotFound"));k[q]=null;if(++m==k.length){e(l,k,b)}});a(o).attr("src",k[q]["src"])})});function e(l,k,m){a(l).find(".jg-loading").fadeOut(500,function(){a(this).remove();g(a,l,k,0,m);if(a.isFunction(m.onComplete)){m.onComplete.call(this,l)}})}function c(s,r,n,q,m,o,p){var k;k='<div class="jg-image" style="left:'+m+'px">';k+=' <a href="'+s.href+'" ';if(typeof s.rel!="undefined"){k+='rel="'+s.rel+'"'}if(typeof s.target!="undefined"){k+='target="'+s.target+'"'}k+='title="'+s.title+'">';k+='  <img alt="'+s.alt+'" src="'+s.src+r+s.extension+'"';k+='style="width: '+n+"px; height: "+q+'px;">';if(p.captions){k+='  <div style="bottom:'+(q-o)+'px;" class="jg-image-label">'+s.alt+"</div>"}k+=" </a></div>";return k}function f(s,n,m,r){var q,o=0;var p;for(var q=0;q<s.length;q++){s[q]["nh"]=Math.ceil(n[s[q]["indx"]]["height"]*((n[s[q]["indx"]]["width"]+m)/n[s[q]["indx"]]["width"]));s[q]["nw"]=n[s[q]["indx"]]["width"]+m;s[q]["suffix"]=d(s[q]["nw"],s[q]["nh"],r);s[q]["l"]=o;if(!r.fixedHeight){if(q==0){p=s[q]["nh"]}else{if(p>s[q]["nh"]){p=s[q]["nh"]}}}o+=s[q]["nw"]+r.margins}if(r.fixedHeight){p=r.rowHeight}var k="";for(var q=0;q<s.length;q++){k+=c(n[s[q]["indx"]],s[q]["suffix"],s[q]["nw"],s[q]["nh"],s[q]["l"],p,r)}return'<div class="jg-row" style="height: '+p+"px; margin-bottom:"+r.margins+'px;">'+k+"</div>"}function d(k,m,l){var o;if(k>m){o=k}else{o=m}if(o<=100){return l.sizeRangeSuffixes.lt100}else{if(o<=240){return l.sizeRangeSuffixes.lt240}else{if(o<=320){return l.sizeRangeSuffixes.lt320}else{if(o<=500){return l.sizeRangeSuffixes.lt500}else{if(o<=640){return l.sizeRangeSuffixes.lt640}else{return l.sizeRangeSuffixes.lt1024}}}}}}function g(o,u,s,r,m){var t=new Array();var n,p;var k=0;var q;var l=o(u).width();for(p=0,n=0;p<s.length;p++){if(s[p]==null){continue}if(k+s[p]["width"]+m.margins<=l){k+=s[p]["width"]+m.margins;t[n]=new Array(5);t[n]["indx"]=p;n++}else{q=Math.ceil((l-k+1)/t.length);o(u).append(f(t,s,q,m));t=new Array();t[0]=new Array(5);t[0]["indx"]=p;n=1;k=s[p]["width"]+m.margins}}if(m.justifyLastRow){q=Math.ceil((l-k+1)/t.length)}else{q=0}o(u).append(f(t,s,q,m));if(m.captions){o(u).find(".jg-image").mouseenter(function(v){o(v.currentTarget).find(".jg-image-label").stop();o(v.currentTarget).find(".jg-image-label").fadeTo(500,0.7)});o(u).find(".jg-image").mouseleave(function(v){o(v.currentTarget).find(".jg-image-label").stop();o(v.currentTarget).find(".jg-image-label").fadeTo(500,0)})}o(u).find(".jg-resizedImageNotFound").remove();o(u).find(".jg-image img").load(function(){o(this).fadeTo(500,1)}).error(function(){o(u).prepend(h("The image can't be loaded: \""+o(this).attr("src")+'"',"jg-resizedImageNotFound"))}).each(function(){if(this.complete){o(this).load()}});i(o,u,s,l,m)}function i(o,l,k,m,n){var p=setInterval(function(){if(m!=o(l).width()){o(l).find(".jg-row").remove();clearInterval(p);g(o,l,k,m,n);return}},n.refreshTime)}}})(jQuery);