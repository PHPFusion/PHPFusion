(function(a){if(typeof exports=="object"&&typeof module=="object"){a(require("../../lib/codemirror"))}else{if(typeof define=="function"&&define.amd){define(["../../lib/codemirror"],a)}else{a(CodeMirror)}}})(function(b){var c={addition:"positive",attributes:"attribute",bold:"strong",cite:"keyword",code:"atom",definitionList:"number",deletion:"negative",div:"punctuation",em:"em",footnote:"variable",footCite:"qualifier",header:"header",html:"comment",image:"string",italic:"em",link:"link",linkDefinition:"link",list1:"variable-2",list2:"variable-3",list3:"keyword",notextile:"string-2",pre:"operator",p:"property",quote:"bracket",span:"quote",specialChar:"tag",strong:"strong",sub:"builtin",sup:"builtin",table:"variable-3",tableHeading:"operator"};function d(f,g,h){this.regExpFactory=f;this.state=g;this.stream=h;this.styles=c;this.state.specialChar=null}d.prototype.eat=function(f){return this.stream.match(this.regExpFactory.pattern(f),true)};d.prototype.check=function(f){return this.stream.match(this.regExpFactory.pattern(f),false)};d.prototype.setModeForNextToken=function(f){return this.state.mode=f};d.prototype.execMode=function(f){return this.setModeForNextToken(f).call(this)};d.prototype.startNewLine=function(){this.setModeForNextToken(a.newLayout);this.state.tableHeading=false;if(this.state.layoutType==="definitionList"&&this.state.spanningLayout){if(this.check("definitionListEnd")){this.state.spanningLayout=false}}};d.prototype.nextToken=function(){return this.state.mode.call(this)};d.prototype.styleFor=function(f){if(this.styles.hasOwnProperty(f)){return this.styles[f]}throw"unknown token"};d.prototype.handlePhraseModifier=function(g){if(g==="_"){if(this.stream.eat("_")){return this.togglePhraseModifier("italic",/^.*__/)}return this.togglePhraseModifier("em",/^.*_/)}if(g==="*"){if(this.stream.eat("*")){return this.togglePhraseModifier("bold",/^.*\*\*/)}return this.togglePhraseModifier("strong",/^.*\*/)}if(g==="["){if(this.stream.match(/\d+\]/)){this.state.footCite=true}return this.tokenStyles()}if(g==="("){if(this.stream.match("r)")){this.state.specialChar="r"}else{if(this.stream.match("tm)")){this.state.specialChar="tm"}else{if(this.stream.match("c)")){this.state.specialChar="c"}}}return this.tokenStyles()}if(g==="<"){if(this.stream.match(/(\w+)[^>]+>[^<]+<\/\1>/)){return this.tokenStylesWith(this.styleFor("html"))}}if(g==="?"&&this.stream.eat("?")){return this.togglePhraseModifier("cite",/^.*\?\?/)}if(g==="="&&this.stream.eat("=")){return this.togglePhraseModifier("notextile",/^.*==/)}if(g==="-"){return this.togglePhraseModifier("deletion",/^.*-/)}if(g==="+"){return this.togglePhraseModifier("addition",/^.*\+/)}if(g==="~"){return this.togglePhraseModifier("sub",/^.*~/)}if(g==="^"){return this.togglePhraseModifier("sup",/^.*\^/)}if(g==="%"){return this.togglePhraseModifier("span",/^.*%/)}if(g==="@"){return this.togglePhraseModifier("code",/^.*@/)}if(g==="!"){var f=this.togglePhraseModifier("image",/^.*(?:\([^\)]+\))?!/);this.stream.match(/^:\S+/);return f}return this.tokenStyles()};d.prototype.togglePhraseModifier=function(f,h){if(this.state[f]){var g=this.tokenStyles();this.state[f]=false;return g}if(this.stream.match(h,false)){this.state[f]=true;this.setModeForNextToken(a.attributes)}return this.tokenStyles()};d.prototype.tokenStyles=function(){var f=this.textileDisabled(),g=[];if(f){return f}if(this.state.layoutType){g.push(this.styleFor(this.state.layoutType))}g=g.concat(this.activeStyles("addition","bold","cite","code","deletion","em","footCite","image","italic","link","span","specialChar","strong","sub","sup","table","tableHeading"));if(this.state.layoutType==="header"){g.push(this.styleFor("header")+"-"+this.state.header)}return g.length?g.join(" "):null};d.prototype.textileDisabled=function(){var f=this.state.layoutType;switch(f){case"notextile":case"code":case"pre":return this.styleFor(f);default:if(this.state.notextile){return this.styleFor("notextile")+(f?(" "+this.styleFor(f)):"")}return null}};d.prototype.tokenStylesWith=function(h){var g=this.textileDisabled(),f;if(g){return g}f=this.tokenStyles();if(h){return f?(f+" "+h):h}return f};d.prototype.activeStyles=function(){var g=[],f;for(f=0;f<arguments.length;++f){if(this.state[arguments[f]]){g.push(this.styleFor(arguments[f]))}}return g};d.prototype.blankLine=function(){var h=this.state.spanningLayout,g=this.state.layoutType,f;for(f in this.state){if(this.state.hasOwnProperty(f)){delete this.state[f]}}this.setModeForNextToken(a.newLayout);if(h){this.state.layoutType=g;this.state.spanningLayout=true}};function e(){this.cache={};this.single={bc:"bc",bq:"bq",definitionList:/- [^(?::=)]+:=+/,definitionListEnd:/.*=:\s*$/,div:"div",drawTable:/\|.*\|/,foot:/fn\d+/,header:/h[1-6]/,html:/\s*<(?:\/)?(\w+)(?:[^>]+)?>(?:[^<]+<\/\1>)?/,link:/[^"]+":\S/,linkDefinition:/\[[^\s\]]+\]\S+/,list:/(?:#+|\*+)/,notextile:"notextile",para:"p",pre:"pre",table:"table",tableCellAttributes:/[/\\]\d+/,tableHeading:/\|_\./,tableText:/[^"_\*\[\(\?\+~\^%@|-]+/,text:/[^!"_=\*\[\(<\?\+~\^%@-]+/};this.attributes={align:/(?:<>|<|>|=)/,selector:/\([^\(][^\)]+\)/,lang:/\[[^\[\]]+\]/,pad:/(?:\(+|\)+){1,2}/,css:/\{[^\}]+\}/}}e.prototype.pattern=function(f){return(this.cache[f]||this.createRe(f))};e.prototype.createRe=function(f){switch(f){case"drawTable":return this.makeRe("^",this.single.drawTable,"$");case"html":return this.makeRe("^",this.single.html,"(?:",this.single.html,")*","$");case"linkDefinition":return this.makeRe("^",this.single.linkDefinition,"$");case"listLayout":return this.makeRe("^",this.single.list,this.pattern("allAttributes"),"*\\s+");case"tableCellAttributes":return this.makeRe("^",this.choiceRe(this.single.tableCellAttributes,this.pattern("allAttributes")),"+\\.");case"type":return this.makeRe("^",this.pattern("allTypes"));case"typeLayout":return this.makeRe("^",this.pattern("allTypes"),this.pattern("allAttributes"),"*\\.\\.?","(\\s+|$)");case"attributes":return this.makeRe("^",this.pattern("allAttributes"),"+");case"allTypes":return this.choiceRe(this.single.div,this.single.foot,this.single.header,this.single.bc,this.single.bq,this.single.notextile,this.single.pre,this.single.table,this.single.para);case"allAttributes":return this.choiceRe(this.attributes.selector,this.attributes.css,this.attributes.lang,this.attributes.align,this.attributes.pad);default:return this.makeRe("^",this.single[f])}};e.prototype.makeRe=function(){var h="",g,f;for(g=0;g<arguments.length;++g){f=arguments[g];h+=(typeof f==="string")?f:f.source}return new RegExp(h)};e.prototype.choiceRe=function(){var g=[arguments[0]],f;for(f=1;f<arguments.length;++f){g[f*2-1]="|";g[f*2]=arguments[f]}g.unshift("(?:");g.push(")");return this.makeRe.apply(this,g)};var a={newLayout:function(){if(this.check("typeLayout")){this.state.spanningLayout=false;return this.execMode(a.blockType)}if(!this.textileDisabled()){if(this.check("listLayout")){return this.execMode(a.list)}else{if(this.check("drawTable")){return this.execMode(a.table)}else{if(this.check("linkDefinition")){return this.execMode(a.linkDefinition)}else{if(this.check("definitionList")){return this.execMode(a.definitionList)}else{if(this.check("html")){return this.execMode(a.html)}}}}}}return this.execMode(a.text)},blockType:function(){var f,g;this.state.layoutType=null;if(f=this.eat("type")){g=f[0]}else{return this.execMode(a.text)}if(f=g.match(this.regExpFactory.pattern("header"))){this.state.layoutType="header";this.state.header=parseInt(f[0][1])}else{if(g.match(this.regExpFactory.pattern("bq"))){this.state.layoutType="quote"}else{if(g.match(this.regExpFactory.pattern("bc"))){this.state.layoutType="code"}else{if(g.match(this.regExpFactory.pattern("foot"))){this.state.layoutType="footnote"}else{if(g.match(this.regExpFactory.pattern("notextile"))){this.state.layoutType="notextile"}else{if(g.match(this.regExpFactory.pattern("pre"))){this.state.layoutType="pre"}else{if(g.match(this.regExpFactory.pattern("div"))){this.state.layoutType="div"}else{if(g.match(this.regExpFactory.pattern("table"))){this.state.layoutType="table"}}}}}}}}this.setModeForNextToken(a.attributes);return this.tokenStyles()},text:function(){if(this.eat("text")){return this.tokenStyles()}var f=this.stream.next();if(f==='"'){return this.execMode(a.link)}return this.handlePhraseModifier(f)},attributes:function(){this.setModeForNextToken(a.layoutLength);if(this.eat("attributes")){return this.tokenStylesWith(this.styleFor("attributes"))}return this.tokenStyles()},layoutLength:function(){if(this.stream.eat(".")&&this.stream.eat(".")){this.state.spanningLayout=true}this.setModeForNextToken(a.text);return this.tokenStyles()},list:function(){var f=this.eat("list"),g;this.state.listDepth=f[0].length;g=(this.state.listDepth-1)%3;if(!g){this.state.layoutType="list1"}else{if(g===1){this.state.layoutType="list2"}else{this.state.layoutType="list3"}}this.setModeForNextToken(a.attributes);return this.tokenStyles()},link:function(){this.setModeForNextToken(a.text);if(this.eat("link")){this.stream.match(/\S+/);return this.tokenStylesWith(this.styleFor("link"))}return this.tokenStyles()},linkDefinition:function(){this.stream.skipToEnd();return this.tokenStylesWith(this.styleFor("linkDefinition"))},definitionList:function(){this.eat("definitionList");this.state.layoutType="definitionList";if(this.stream.match(/\s*$/)){this.state.spanningLayout=true}else{this.setModeForNextToken(a.attributes)}return this.tokenStyles()},html:function(){this.stream.skipToEnd();return this.tokenStylesWith(this.styleFor("html"))},table:function(){this.state.layoutType="table";return this.execMode(a.tableCell)},tableCell:function(){if(this.eat("tableHeading")){this.state.tableHeading=true}else{this.stream.eat("|")}this.setModeForNextToken(a.tableCellAttributes);return this.tokenStyles()},tableCellAttributes:function(){this.setModeForNextToken(a.tableText);if(this.eat("tableCellAttributes")){return this.tokenStylesWith(this.styleFor("attributes"))}return this.tokenStyles()},tableText:function(){if(this.eat("tableText")){return this.tokenStyles()}if(this.stream.peek()==="|"){this.setModeForNextToken(a.tableCell);return this.tokenStyles()}return this.handlePhraseModifier(this.stream.next())}};b.defineMode("textile",function(){var f=new e();return{startState:function(){return{mode:a.newLayout}},token:function(h,g){var i=new d(f,g,h);if(h.sol()){i.startNewLine()}return i.nextToken()},blankLine:function(g){new d(f,g).blankLine()}}});b.defineMIME("text/x-textile","textile")});